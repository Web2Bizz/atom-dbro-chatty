#!/bin/sh

# ะกะบัะธะฟั ัะฑะพัะบะธ ะฟัะพะตะบัะฐ Chatty Server
# ะกะพะฑะธัะฐะตั ะฟัะพะตะบั ะธ ะฟะตัะตะผะตัะฐะตั ัะฐะนะปั ะธะท dist/src ะฒ dist

set -e

# ะะฟัะตะดะตะปัะตะผ ัะฐะฑะพััั ะดะธัะตะบัะพัะธั ะธ ะฟััั ะบ dist
# ะัะปะธ ัะบัะธะฟั ะทะฐะฟััะตะฝ ะธะท ะบะพัะฝั ะฟัะพะตะบัะฐ, ะฟะตัะตัะพะดะธะผ ะฒ server, dist ะฑัะดะตั ะฒ ะบะพัะฝะต
# ะัะปะธ ัะบัะธะฟั ะทะฐะฟััะตะฝ ะธะท Docker (ะณะดะต ัะฐะนะปั ัะถะต ะฒ ะบะพัะฝะต), ัะฐะฑะพัะฐะตะผ ะฒ ัะตะบััะตะน ะดะธัะตะบัะพัะธะธ
if [ -d "server" ] && [ -f "server/package.json" ]; then
  # ะะฐะฟััะบ ะธะท ะบะพัะฝั ะฟัะพะตะบัะฐ
  SERVER_DIR="server"
  DIST_DIR="dist"
  cd server || { echo "โ ะัะธะฑะบะฐ: ะดะธัะตะบัะพัะธั server ะฝะต ะฝะฐะนะดะตะฝะฐ"; exit 1; }
elif [ ! -f "package.json" ]; then
  echo "โ ะัะธะฑะบะฐ: package.json ะฝะต ะฝะฐะนะดะตะฝ. ะฃะฑะตะดะธัะตัั, ััะพ ัะบัะธะฟั ะทะฐะฟััะตะฝ ะธะท ะฟัะฐะฒะธะปัะฝะพะน ะดะธัะตะบัะพัะธะธ"
  exit 1
else
  # Docker - ัะฐะฑะพัะฐะตะผ ะฒ ัะตะบััะตะน ะดะธัะตะบัะพัะธะธ
  SERVER_DIR="."
  DIST_DIR="dist"
fi

echo "๐จ ะะฐัะธะฝะฐะตะผ ัะฑะพัะบั ะฟัะพะตะบัะฐ..."

# ะัะธััะบะฐ ะฟัะตะดัะดััะตะน ัะฑะพัะบะธ
echo "๐งน ะัะธััะบะฐ ะดะธัะตะบัะพัะธะธ dist..."
if [ "$SERVER_DIR" = "server" ]; then
  # ะัะปะธ ะทะฐะฟััะบ ะธะท ะบะพัะฝั ะฟัะพะตะบัะฐ, dist ะฒ ะบะพัะฝะต
  cd .. && rm -rf dist && cd server
  # ะขะฐะบะถะต ัะดะฐะปัะตะผ dist ะธะท server, ะตัะปะธ ะพะฝ ัะฐะผ ะตััั (ะฝะฐ ัะปััะฐะน ััะฐััั ัะฑะพัะพะบ)
  rm -rf dist
else
  # Docker - dist ะฒ ัะตะบััะตะน ะดะธัะตะบัะพัะธะธ
  rm -rf dist
fi

# ะฃะดะฐะปะตะฝะธะต ะปัะฑัั ัะบะพะผะฟะธะปะธัะพะฒะฐะฝะฝัั ัะฐะนะปะพะฒ ะธะท ะบะพัะฝั ะฟัะพะตะบัะฐ (ะฒัะต ะดะพะปะถะฝะพ ะฑััั ะฒ dist)
echo "๐งน ะัะธััะบะฐ ัะบะพะผะฟะธะปะธัะพะฒะฐะฝะฝัั ัะฐะนะปะพะฒ ะธะท ะบะพัะฝั ะฟัะพะตะบัะฐ..."
# ะฃะดะฐะปัะตะผ ัะพะปัะบะพ ะธะทะฒะตััะฝัะต ัะฐะนะปั, ะบะพัะพััะต ะฝะต ะดะพะปะถะฝั ะบะพะผะฟะธะปะธัะพะฒะฐัััั
rm -f drizzle.config.js drizzle.config.d.ts drizzle.config.js.map
rm -f tsconfig.tsbuildinfo

# ะกะฑะพัะบะฐ ะฟัะพะตะบัะฐ ัะตัะตะท NestJS CLI
echo "๐ฆ ะกะฑะพัะบะฐ ัะตัะตะท NestJS..."
pnpm run build

# ะะฟัะตะดะตะปัะตะผ ะฟััั ะบ dist ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ะบะพะฝัะตะบััะฐ
if [ "$SERVER_DIR" = "server" ]; then
  DIST_PATH="../dist"
else
  DIST_PATH="dist"
fi

# ะัะพะฒะตััะตะผ, ัััะตััะฒัะตั ะปะธ dist/src
if [ -d "$DIST_PATH/src" ]; then
  echo "๐ ะะตัะตะผะตัะตะฝะธะต ัะฐะนะปะพะฒ ะธะท dist/src ะฒ dist..."
  
  # ะะตัะตะผะตัะฐะตะผ ะฒัะต ัะพะดะตัะถะธะผะพะต ะธะท dist/src ะฒ dist
  # ะัะฟะพะปัะทัะตะผ find ะดะปั ะฝะฐะดะตะถะฝะพะณะพ ะฟะตัะตะผะตัะตะฝะธั ะฒัะตั ัะฐะนะปะพะฒ
  find "$DIST_PATH/src" -mindepth 1 -maxdepth 1 -exec mv {} "$DIST_PATH/" \;
  
  # ะฃะดะฐะปัะตะผ ะฟััััั ะดะธัะตะบัะพัะธั src
  rmdir "$DIST_PATH/src" 2>/dev/null || true
  
  echo "โ ะคะฐะนะปั ััะฟะตัะฝะพ ะฟะตัะตะผะตัะตะฝั"
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต main.js
if [ ! -f "$DIST_PATH/main.js" ]; then
  echo "โ ะัะธะฑะบะฐ: $DIST_PATH/main.js ะฝะต ะฝะฐะนะดะตะฝ ะฟะพัะปะต ัะฑะพัะบะธ"
  echo "๐ ะกะพะดะตัะถะธะผะพะต dist:"
  ls -la "$DIST_PATH/" 2>/dev/null || dir "$DIST_PATH" 2>/dev/null || echo "dist ะฟัััะฐ"
  exit 1
fi

echo "โ ะกะฑะพัะบะฐ ะทะฐะฒะตััะตะฝะฐ ััะฟะตัะฝะพ!"
if [ "$SERVER_DIR" = "server" ]; then
  echo "๐ ะะปะฐะฒะฝัะน ัะฐะนะป: dist/main.js (ะฒ ะบะพัะฝะต ะฟัะพะตะบัะฐ)"
else
  echo "๐ ะะปะฐะฒะฝัะน ัะฐะนะป: dist/main.js"
fi

