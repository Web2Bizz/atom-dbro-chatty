# Система прав доступа (Scopes) для API ключей

## Обзор

Система scopes позволяет контролировать права доступа API ключей к различным ресурсам системы. Каждый API ключ может иметь один или несколько scopes, которые определяют, какие действия он может выполнять.

### Важные особенности

- **`allow-all` scope** дает полный доступ ко всем операциям системы, включая все операции с чатами и пользователями
- **JWT пользователи** (обычные пользователи) автоматически имеют полный доступ и не требуют проверки scopes
- **Все операции с чатами** требуют scope `allow-all-chats`, `allow-create-rooms` или `allow-all` для API ключей
- **Создание комнат** требует scope `allow-all-chats`, `allow-create-rooms` или `allow-all` для API ключей
- Scope `allow-all` автоматически заменяет любые другие требования к scopes

## Доступные Scopes

### `allow-all`
**Описание**: Полный доступ ко всем функциям системы (супер-право)

**Применение**: Обладатель этого scope может выполнять **все** действия в системе, включая:
- **Все операции с чатами/комнатами:**
  - Создание комнат (`POST /api/v1/rooms`)
  - Просмотр всех комнат, включая приватные (`GET /api/v1/rooms`)
  - Получение информации о конкретной комнате (`GET /api/v1/rooms/:id`)
  - Получение истории сообщений из любых комнат (`GET /api/v1/rooms/:id/messages`)
  - Отправка сообщений в любые комнаты (`POST /api/v1/rooms/:id/messages`)
- **Все операции с пользователями:**
  - Просмотр всех пользователей (`GET /api/v1/users`)
  - Просмотр профилей пользователей
- Все остальные операции без ограничений

**Важно**: Scope `allow-all` автоматически дает доступ ко всем операциям, которые требуют других scopes. Например, если эндпоинт требует `allow-all-chats`, то API ключ с `allow-all` также получит доступ.

**Использование**: Используйте этот scope только для доверенных API ключей, которым нужен полный доступ.

### `allow-all-chats`
**Описание**: Доступ ко всем операциям с чатами/комнатами системы

**Применение**: API ключ с этим scope может выполнять **все операции с чатами:**
- Создание новых комнат (`POST /api/v1/rooms`)
- Просмотр всех комнат, включая приватные (`GET /api/v1/rooms`)
- Получение информации о конкретной комнате (`GET /api/v1/rooms/:id`)
- Получение истории сообщений из любых комнат (`GET /api/v1/rooms/:id/messages`)
- Отправка сообщений в любые комнаты (`POST /api/v1/rooms/:id/messages`)

**Защищенные эндпоинты**: Все операции с чатами требуют scope `allow-all-chats`, `allow-create-rooms` или `allow-all`. JWT пользователи имеют полный доступ автоматически.

**Пример использования**: Мониторинг системы, аналитика чатов, интеграции с внешними системами, боты и автоматизация работы с чатами.

### `allow-create-rooms`
**Описание**: Разрешение на создание комнат и доступ к созданным комнатам

**Применение**: API ключ с этим scope может:
- Создавать новые комнаты (`POST /api/v1/rooms`)
- Просматривать только комнаты, созданные этим API ключом (`GET /api/v1/rooms`)
- Получать информацию о созданных комнатах (`GET /api/v1/rooms/:id`)
- Получать историю сообщений из созданных комнат (`GET /api/v1/rooms/:id/messages`)
- Отправлять сообщения в созданные комнаты (`POST /api/v1/rooms/:id/messages`)

**Важно**: Этот scope **НЕ дает** доступ ко всем комнатам системы. API ключ может работать только с комнатами, которые он сам создал. Для доступа ко всем комнатам системы используйте scope `allow-all-chats` или `allow-all`.

**Защищенные эндпоинты**: Операции с комнатами требуют scope `allow-all-chats`, `allow-create-rooms` или `allow-all`. JWT пользователи имеют полный доступ автоматически.

**Пример использования**: Интеграции, которые создают собственные чаты для пользователей, боты, которые работают только со своими комнатами, приложения с ограниченным доступом к чатам.

### `allow-all-users`
**Описание**: Доступ ко всем пользователям системы

**Применение**: API ключ с этим scope может:
- Просматривать список всех пользователей
- Получать профили пользователей
- Просматривать данные пользователей

**Пример использования**: Административные панели, отчеты по пользователям, интеграции с CRM системами.

## Создание API ключа с scopes

### Пример запроса

```bash
curl -X POST 'http://localhost:3000/api/v1/auth/api-keys' \
  -H 'Authorization: Bearer <your-jwt-token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "name": "Analytics API Key",
    "expiresInDays": 30,
    "scopes": [
      "allow-all-chats",
      "allow-all-users"
    ]
  }'
```

### Валидные scopes

При создании API ключа можно указать следующие scopes:
- `allow-all`
- `allow-all-chats`
- `allow-create-rooms`
- `allow-all-users`

Можно указать несколько scopes одновременно. Если scope не указан, API ключ будет создан без специальных прав (только базовый доступ к публичным эндпоинтам).

## Использование в коде

### Декораторы для проверки scopes

В контроллерах можно использовать следующие декораторы для ограничения доступа:

#### `@RequireScope(scope)`
Требует наличие конкретного scope:

```typescript
import { RequireScope } from '../auth/scopes/scopes.decorator';
import { Scope } from '../auth/scopes/scopes.constants';

@Get('rooms')
@RequireScope(Scope.ALLOW_ALL_CHATS)
async getAllRooms() {
  // Только API ключи с scope 'allow-all-chats' или 'allow-all' могут получить доступ
}
```

#### `@RequireAnyScope(...scopes)`
Требует наличие хотя бы одного из указанных scopes:

```typescript
@RequireAnyScope(Scope.ALLOW_ALL_CHATS, Scope.ALLOW_ALL_USERS)
@Get('data')
async getData() {
  // API ключ должен иметь хотя бы один из указанных scopes
}
```

#### `@RequireAllScopes(...scopes)`
Требует наличие всех указанных scopes:

```typescript
@RequireAllScopes(Scope.ALLOW_ALL_CHATS, Scope.ALLOW_ALL_USERS)
@Get('combined')
async getCombined() {
  // API ключ должен иметь все указанные scopes
}
```

## Важные замечания

### JWT пользователи
Пользователи, аутентифицированные через JWT токены (обычные пользователи), **всегда имеют полный доступ** и не требуют проверки scopes. Система scopes применяется только к API ключам.

### Проверка прав
- Если API ключ не имеет требуемого scope, запрос будет отклонен с кодом `403 Forbidden`
- Scope `allow-all` дает доступ ко всем функциям независимо от других требований
- Если при создании API ключа scopes не указаны, ключ будет работать только с публичными эндпоинтами

### Безопасность
- Никогда не используйте scope `allow-all` для API ключей, которым не нужен полный доступ
- Регулярно пересматривайте и обновляйте scopes для ваших API ключей
- Используйте короткие сроки действия для API ключей с расширенными правами

## Примеры использования

### Создание API ключа для мониторинга чатов

```json
{
  "name": "Chat Monitor",
  "expiresInDays": 90,
  "scopes": ["allow-all-chats"]
}
```

### Создание API ключа для административной панели

```json
{
  "name": "Admin Panel",
  "expiresInDays": 365,
  "scopes": ["allow-all-chats", "allow-all-users"]
}
```

### Создание API ключа для создания собственных комнат

```json
{
  "name": "Room Creator Bot",
  "expiresInDays": 90,
  "scopes": ["allow-create-rooms"]
}
```

### Создание API ключа с полным доступом

```json
{
  "name": "Full Access Key",
  "expiresInDays": 30,
  "scopes": ["allow-all"]
}
```

**Важно**: API ключ с scope `allow-all` автоматически получает доступ ко **всем** операциям с чатами:
- ✅ Создание комнат
- ✅ Просмотр всех комнат (включая приватные)
- ✅ Получение информации о комнатах
- ✅ Получение истории сообщений
- ✅ Отправка сообщений
- ✅ Все операции с пользователями
- ✅ Любые другие операции в системе

Нет необходимости указывать дополнительные scopes вместе с `allow-all`.

## Расширение системы

Для добавления новых scopes:

1. Добавьте новый scope в enum `Scope` в `src/auth/scopes/scopes.constants.ts`
2. Добавьте описание в `SCOPE_METADATA`
3. Используйте новый scope в декораторах контроллеров
4. Обновите документацию

Пример:

```typescript
export enum Scope {
  // ... существующие scopes
  ALLOW_MESSAGE_DELETE = 'allow-message-delete',
}

export const SCOPE_METADATA: Record<Scope, { description: string }> = {
  // ... существующие метаданные
  [Scope.ALLOW_MESSAGE_DELETE]: {
    description: 'Permission to delete messages in chats',
  },
};
```

